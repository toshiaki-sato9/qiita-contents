---
title: IoTデバイスへの第三者ペネトレーションテスト実施内容
tags:
  - Security
  - devops
  - yocto
  - IoT
  - 組み込みLinux
private: true
updated_at: '2026-02-12T21:57:12+09:00'
id: 640d1935091d6f65de8d
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

私たちShizen Connectは、「青い地球を未来へ繋ぐ」をミッションとして、再生可能エネルギーを効率良く生成・制御するために、クラウドからエッジまで全てのレイヤ技術を駆使して最先端のVPP技術を日々研究開発しています。

私はこの中で Shizen Box というエッジデバイスをメインに開発しています。Shizen Box は、エネルギーマネジメントシステムを支えるエッジ端末で、複数のプロトコル機器との接続・連系制御を可能とするデバイスです。

本記事は、Shizen Boxに対して実施した第三者ペネトレーションテスト（以下、ペンテスト）の実施内容について紹介します。

### 連載構成

- 第一回：開発・検証環境を整える
- 第二回：事前の守備固め（侵入対策・DOS対策など）
- **第三回：第三者ペネトレーションテストの実施内容**（本記事）
- 第四回：指摘された脆弱性
- 第五回：対策と運用改善

※ 各回は単体でも読めますが、時系列で読むと全体像が分かる構成としています。

### 第三回の内容

今回は、実際に第三者機関に依頼したペネトレーションテストの具体的な実施内容について説明します。

IoTデバイスのセキュリティリスクは、情報セキュリティの三大要素である**機密性（Confidentiality）**、**完全性（Integrity）**、**可用性（Availability）**の観点から整理できます。Shizen Boxのペンテストでは、これらのリスクに対して以下の4つのテストを実施しました。

- テスト１：ファームウェアの抽出と解析（機密性）
- テスト２：WebUIやOSを介した不正アクセス（完全性）
- テスト３：ModbusおよびECHONET Liteでのファジングテスト（完全性）
- テスト４：NW経由でのDOS攻撃（可用性）

それぞれのテストについて、想定リスクと実施内容を詳しく紹介します。

---

## 想定リスクとペネトレーションテストの全体構成

IoTデバイスにおけるセキュリティリスクを、情報セキュリティの三大要素に基づいて整理しました。

| リスク分類 | 想定される脅威 | 実施したテスト |
|-----------|--------------|--------------|
| **機密性（Confidentiality）** | 情報漏洩 | テスト１：ファームウェアの抽出と解析 |
| **完全性（Integrity）** | 改ざん・不正操作 | テスト２：WebUIやOSを介した不正アクセス<br>テスト３：ModbusおよびECHONET Liteでのファジングテスト |
| **可用性（Availability）** | サービス停止 | テスト４：NW経由でのDOS攻撃 |

以降のセクションでは、まずペンテスト実施中の監視体制について説明した後、各リスクとテスト内容について詳しく説明します。

---

## ペンテスト実施中の監視体制

第二回で紹介した守備固めでは、「入口を作らない」「触ったら分かる」設計を目指しました。この「触ったら分かる」を実現するため、ペンテスト実施中は侵入試行をリアルタイムで検知し、Slackへ通知する仕組みを導入しました。

### 実装方針：軽量なログベース検知

IoTデバイスは計算リソースが限られるため、重厚なIDS/IPS（侵入検知・防御システム）を導入することは現実的ではありません。そこで、**iptablesのLOGオプション**を活用した軽量な実装を採用しました。

### 仕組み

侵入検知から通知までのフローは以下の通りです。

```
1. 特定ポートへのアクセス試行
   ↓
2. iptables LOGルールで検知・記録
   ↓
3. Shizen Box → クラウドへ通知
   ↓
4. クラウド → Slack へ通知
```

#### iptables LOGルールの設定例

```bash
# 不正アクセスの疑いがあるポートへのアクセスをログ記録
iptables -A INPUT -p tcp --dport 22 -j LOG \
  --log-prefix "[PENTEST-SSH] " --log-level 4

iptables -A INPUT -p tcp --dport 80 -j LOG \
  --log-prefix "[PENTEST-HTTP] " --log-level 4
```

特定のポート（SSH、HTTP、その他の監視対象ポート）へのアクセスを検知すると、カーネルログに記録されます。

#### 通知フロー

1. **Shizen Box側**
   - ログファイルを監視し、特定のパターン（`[PENTEST-*]`など）を検知
   - 検知したアクセス情報をクラウドAPIへ送信

2. **クラウド側**
   - Shizen Boxからの通知を受信
   - Slack Incoming Webhookを使用してチャンネルへ投稿

### 通知内容の例

```
🚨 侵入試行を検知しました

デバイス: ShizenBox-Test-01
時刻: 2025-12-15 14:32:10
送信元IP: 203.0.113.45
対象ポート: 22 (SSH)
プロトコル: TCP SYN
```

### ペンテスト実施中の運用

ペンテスト期間中、この仕組みにより以下の情報をリアルタイムで把握できました。

- どのタイミングでテスト機関が攻撃を開始したか
- どのポートが標的にされたか
- ポートスキャンのパターンや頻度

これにより、開発チームはペンテストの進捗を把握し、想定外の挙動があった場合は即座に対応できる体制を整えました。

### 軽量実装のメリット

この実装の利点は以下の通りです。

- **リソース効率**：iptablesのログ機能のみで実現でき、追加の常駐プロセスが不要
- **シンプル**：既存のファイアーウォールルールに数行追加するだけ
- **柔軟性**：監視対象ポートやログパターンを容易に変更可能
- **デバイス負荷が低い**：ログ転送は非同期で行うため、デバイス本来の動作に影響しない

この仕組みは、ペンテスト期間中の一時的な監視だけでなく、運用時の異常検知にも応用可能です。

---

## リスク：情報漏洩（機密性）

### テスト１：ファームウェアの抽出と解析（タンパテスト）

IoTデバイスが物理的に攻撃者の手に渡った場合、基板から直接ファームウェアを抽出され、内部に保存された機密情報（認証情報、秘密鍵、API キーなど）が漏洩するリスクがあります。

このリスクに対して、**ハードウェアへの物理的攻撃を含むタンパテスト**を実施しました。

#### テスト内容

- 基板改造などハードウェアへの直接的な攻撃
- eMMCからのファームウェアイメージの抽出
- 抽出したファームウェアの静的解析
- ファイルシステム内の機密情報の探索

#### テスト機関への提供情報

テスト機関がハードウェアアクセスを効率的に実施できるよう、以下の情報を事前に提供しました。

- **eMMCのパターンデザイン図**：基板上のeMMCチップの位置と配線パターン
- **アクセス方法**：データ線へのアクセス手順や推奨される接続方法

これにより、テスト機関は物理的な破壊を最小限に抑えながら、実際の攻撃シナリオに即した検証を実施できました。

#### 検証のポイント

- ファームウェアが暗号化されているか
- 平文で保存された認証情報や秘密鍵が存在しないか
- ハードウェアセキュリティモジュール（HSM）やTrusted Execution Environment（TEE）などの保護機能が適切に機能しているか

---

## リスク：改ざん・不正操作（完全性）

### テスト２：WebUIやOSを介した不正アクセス

Shizen Boxは、メンテナンス用のWebUIやSSH接続を提供しています。これらのインタフェースに対する不正アクセスにより、システム設定の改ざんや機密情報の奪取が行われるリスクがあります。

#### テスト内容

- WebUI認証機構の脆弱性検証
- セッション管理の安全性確認
- OSレベルでの権限昇格攻撃
- SQLインジェクション、XSS、CSRFなど一般的なWeb脆弱性の検証
- ディレクトリトラバーサル攻撃
- 総当たり攻撃（ブルートフォース）に対する耐性確認

#### テスト機関への提供情報

- **守るべき機密情報のリスト**：認証情報、設定ファイル、ログファイルなど
- WebUIの機能仕様と想定される利用シナリオ
- OS構成とユーザー権限設計

これらの情報をもとに、実際の攻撃者が狙うであろう情報に対して、不正アクセスにより奪取されないことを確認しました。

---

### テスト３：ModbusおよびECHONET Liteでのファジングテスト

Shizen Boxは、エネルギー機器との通信に**Modbus TCP**および**ECHONET Lite**プロトコルを使用しています。これらのプロトコル実装に脆弱性があると、不正なパケットにより以下のリスクが発生する可能性があります。

- デバイスのクラッシュやハング
- メモリ破壊による任意コード実行
- 意図しない機器制御や設定変更

これらのリスクを検証するため、**ファジングテスト**を実施しました。

#### ファジングテストとは

ファジング（Fuzzing）とは、意図的に不正な形式や予期しない値のデータ（ファズ）を入力し、プログラムの異常動作や脆弱性を発見する手法です。

#### テスト内容

- Modbusプロトコルに対する異常パケット送信
  - 不正なファンクションコード
  - 範囲外のレジスタアドレス
  - 異常なデータ長
- ECHONET Liteプロトコルに対する異常パケット送信
  - 不正なEPC（プロパティコード）
  - 異常なEDT（プロパティ値データ）
  - 不正なシーケンス

#### テスト機関への提供情報

テスト機関が効果的なFuzzerを設計・実装できるよう、以下の情報を提供しました。

- **Modbusの実装仕様**：対応ファンクションコード、レジスタマップ
- **ECHONET Liteの実装仕様**：対応オブジェクト、EPC一覧、EDT仕様
- プロトコルスタックの構成と処理フロー
- 想定される正常な通信シーケンス

これらの情報により、テスト機関は実装固有の特性を考慮した効果的なファジングテストを実施できました。

---

## リスク：サービス停止（可用性）

### テスト４：NW経由でのDOS攻撃

IoTデバイスがDoS（Denial of Service）攻撃を受けると、エネルギー制御システム全体の停止につながる可能性があります。Shizen Boxの可用性を確保するため、複数のDoS攻撃シナリオを検証しました。

#### テスト内容

ネットワーク経由での以下のDoS攻撃を実施し、サービス継続性を確認しました。

##### 1. Flood攻撃

大量のパケットを送信してネットワーク帯域やシステムリソースを枯渇させる攻撃です。

- **ICMP Flood攻撃**
  - 大量のICMPエコー要求（ping）を送信し、応答処理でCPUやネットワーク帯域を消費させる攻撃

- **SYN Flood攻撃**
  - TCP接続の3ウェイハンドシェイクを悪用し、大量のSYNパケットを送信してコネクションテーブルを枯渇させる攻撃

- **UDP Flood攻撃**
  - 大量のUDPパケットを送信してネットワーク帯域を消費させる攻撃

##### 2. AMP攻撃対象サービスの調査

Amplification（増幅）攻撃は、送信元を偽装したパケットに対してデバイスが大きな応答を返すことで、被害者に大量のトラフィックを送りつける攻撃です。

一般的なAMP攻撃の対象となりうるサービスが、Shizen Box上で動作していないか、また意図せず増幅攻撃の踏み台となる可能性がないかを調査しました。

- NTP（Network Time Protocol）
- DNS
- SNMP（Simple Network Management Protocol）
- その他UDPベースのサービス

##### 3. IP Spoofing（送信元偽装）による応答確認

攻撃者が送信元IPアドレスを偽装したパケットを送信した際に、Shizen Boxが応答を返すかを確認しました。

- 偽装されたIPアドレスからのパケットに対する応答の有無
- ファイアーウォールルールによる送信元検証の有効性
- 増幅攻撃の踏み台として悪用される可能性の評価

#### 検証のポイント

- 第二回で紹介したカーネルレベルのDoS対策（SYN Cookies、レート制限など）が有効に機能しているか
- 攻撃を受けてもサービスが継続できるか
- 攻撃が終了した後、正常にサービスが復旧するか

---

## おわりに

本記事では、Shizen Boxに対して実施した第三者ペネトレーションテストの内容を、情報セキュリティの三大要素（機密性・完全性・可用性）の観点から紹介しました。

IoTデバイスのペンテストでは、単なるソフトウェアの脆弱性診断だけでなく、ハードウェアへの物理的攻撃や、デバイス固有のプロトコルに対する攻撃など、多角的な視点が必要です。

特に重要なのは、**テスト機関への適切な情報提供**です。ハードウェア構成、実装仕様、守るべき機密情報などを明確に共有することで、より実践的で効果的な検証が可能になります。

また、iptablesのLOGオプションを活用した軽量な侵入検知の仕組みにより、ペンテスト期間中も攻撃状況をリアルタイムで把握することができました。

次回（第四回）では、これらのペンテストで実際に指摘された脆弱性と、その深刻度評価について紹介します。

同じようにIoT / 組み込みデバイスのセキュリティ対策に向き合っている方の参考になれば幸いです。

### 注意事項

- 本記事は、公開可能な一般的技術知見をもとに、個人の経験として執筆しています。
- 特定の製品仕様、社内限定情報、非公開設定値、実環境を特定可能な情報は含んでいません。
- テスト内容・手法は一部簡略化または一般化しています。

記載内容はあくまで一例であり、すべてのIoT機器・システムにそのまま適用できるものではありません。実際のペンテスト実施にあたっては、対象環境やリスクレベルに応じた検討が必要です。


---
title: ペンテストに備えるIoTデバイスの守備固め
tags:
  - Security
  - devops
  - yocto
  - IoT
  - 組み込みLinux
private: true
updated_at: '2026-02-10T21:29:08+09:00'
id: a2ec2df774b2807573d8
organization_url_name: null
slide: false
ignorePublish: false
---
## はじめに

私たちShizen Connectは、「青い地球を未来へ繋ぐ」をミッションとして、再生可能エネルギーを効率良く生成・制御するために、クラウドからエッジまで全てのレイヤ技術を駆使して最先端のVPP技術を日々研究開発しています。

私はこの中で Shizen Box というエッジデバイスをメインに開発しています。Shizen Box は、エネルギーマネジメントシステムを支えるエッジ端末で、複数のプロトコル機器との接続・連系制御を可能とするデバイスです。

昨年、Shizen Boxは第三者ペネトレーションテスト（以下、ペンテスト）を実施しました。本記事では、私がペンテスト対応した実務経験をもとに、設計・実装・運用の観点で得られた知見を整理した連載を予定しています。

### 連載構成

- 第一回：開発・検証環境を整える
- **第二回：事前の守備固め（侵入対策・DOS対策など）**（本記事）
- 第三回：第三者ペネトレーションテストの実施内容
- 第四回：指摘された脆弱性
- 第五回：対策と運用改善

※ 各回は単体でも読めますが、時系列で読むと全体像が分かる構成としています。

### 第二回の内容

今回は、ペンテスト実施前に行った守備固め、すなわち攻撃対象となり得る入口を減らすための基礎対策について説明します。

ペンテスト対応を見据えた守備固めには、以下の要点がありました。

- 不要なサービス・プロセス・ポートを最初から存在させない設計
- ファイアーウォールによる明示的な通信制御
- 物理インタフェースのセキュリティ対策
- カーネルレベルでのDOS攻撃への耐性

DOS対策だけでなく、不要な侵入口を作らないための設計判断と、その実装について紹介します。
また、Shizen Boxは、一般社団法人環境共創イニシアチブが定める[JC-STAR（Japan Cybersecurity Standards, Certification Scheme for Advanced & Trusted IoT）](https://sii.or.jp/jc-star/)の★1認証を取得しており、本記事で紹介する対策は、ペンテスト対応だけでなく、このセキュリティ要件のうちの一つである、

```
6-1. 全ての未使用の物理的インタフェース及び論理的インタフェースは無効化しなければならない。
```

への対応も兼ねて参考情報を記載します。

## 不要なサービス・プロセスの棚卸し

通常の組み込み Linux 開発では、ベンダー提供の BSP をベースに自社用の rootfs を構築するケースが多いです。この BSP には、製品用途では不要なパッケージやサービスが初期状態で含まれていることが少なくありません。

そこで、以下の観点で棚卸しを実施しました。

- 起動時に常駐している不要プロセスはないか  
- 外部通信を行うサービスが意図せず有効になっていないか  
- デバッグ用途のサービスが残っていないか  

確認には主に以下を使用しました。

```bash
ps aux
systemctl list-units --type=service
netstat -tulnp
```

不要と判断したサービス・パッケージは**rootfs ビルド時点で除外**し、運用時に停止するのではなく「存在しない状態」としました。この対応は、JC-STAR 要件における**「不要なサービス・ポートを開放しないこと」**にも直接対応します。

---

## 論理的インタフェースの封鎖（ファイアーウォールによる通信制御）

サービス削減に加え、**ファイアーウォールによる明示的な通信制御**を実施しました。

基本方針は以下です。

* INPUT は原則 DROP
* 必要な通信のみ個別に許可
* メンテナンス用途の経路のみ例外的に開放

### デフォルトポリシー

```bash
iptables -P INPUT DROP
iptables -P FORWARD DROP
iptables -P OUTPUT ACCEPT
```

### 既存セッションの許可

```bash
iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
```

### NTP クライアント通信の許可例

```bash
# NTP サーバへの送信
iptables -A OUTPUT -p udp --dport 123 \
  -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT

# 応答パケットのみ受信
iptables -A INPUT -p udp --sport 123 \
  -m conntrack --ctstate ESTABLISHED -j ACCEPT
```

外部からの新規接続は受け付けず、
**端末が自ら開始した通信の応答のみを許可**する構成としています。

---

## 外部からの見え方の確認

設定が正しく機能しているかを確認するため、
ファイアーウォール設定前後で Nmap によるスキャンを実施しました。

```bash
nmap -sS <target-ip>
```

**注意**: Nmap はデフォルトでは全ポート（65535ポート）をスキャンせず、よく使われる上位1000ポートのみをスキャンします。全ポートを確認する場合は、ポート範囲を明示的に指定してください。

```bash
# 全ポートをスキャンする場合（1-65535を明示）
nmap -sS -p 1-65535 <target-ip>

# 省略形（-p- は -p 1-65535 と同義）
nmap -sS -p- <target-ip>
```

スキャン漏れがないよう、検証目的に応じてポート範囲を明示的に指定することを推奨します。

* 設定前：複数ポートが open / filtered として検出されました
* 設定後：不要なポートは検出されない状態になりました

理想的には SYN スキャンに対しても完全に不可視としたかったが、
本構成では

* **見えても入れない**
* **入ろうとしたら検知される**

という設計方針を採用しました。

侵入試行の検知・通知については第三回で紹介します。

---

## 物理的インタフェースの封鎖

物理インタフェースも重要な侵入口です。

Shizen Boxでは、通常シリアルデバッグポート経由でログイン可能な構成のため、**キッティング検査完了時に当該ポートを封鎖する設計**としています。

具体的な実装方法についてはセキュリティ上の理由から詳細は控えますが、

* 製造・検査時のみ有効
* 出荷状態では無効
* 必要な場合のみ意図的に復帰可能

という状態遷移を設計しています。

これも JC-STAR ★１のセキュリティ要件における、**「未使用の物理的インタフェースを無効化する」**方針に沿った対応です。

---

## DOS 対策（カーネルレベル）

DOS 攻撃に対しては、sysctl ではなく Linux カーネルのコンフィグレーションを直接変更し、ビルド成果物自体に耐性を持たせました。

運用時に設定が変更される余地を減らし、セキュアバイデフォルトを担保する構成としています。

以下の設定は、LPICやLINUCといったLinux技術者資格試験問題にも出題される一般的な設定を有効化しています。

### SYN Flood 対策

```text
CONFIG_SYN_COOKIES=y
```

SYN Cookies を有効化することで、SYN Flood 攻撃時にもコネクション確立を継続できるようにしています。これはTCP ハーフオープンコネクションのバックログを枯渇させる攻撃に対する基本的な対策です。

### netfilter 機能の有効化

```text
CONFIG_NETFILTER=y
CONFIG_NETFILTER_ADVANCED=y
```

意図的に破損させたパケットや以上なフラグ構成による負荷を軽減するため、
カーネルレベルでのパケットフィルタリング機能を有効化して、iptablesによるフィルタリングだけでなく、カーネル内部でのパケット検証処理を有効化することで異常通信に対する耐性を高める対策です。

### 接続追跡と状態管理

```text
CONFIG_NETFILTER_XT_MATCH_CONNTRACK=y
CONFIG_NETFILTER_XT_MATCH_STATE=y
```

接続追跡機能により、ステートフルファイアウォールを実現しています。これにより、既存のセッションからの応答パケットのみを許可し、外部からの新規接続を効果的に遮断できます。

### レート制限とポートスキャン対策

```text
CONFIG_NETFILTER_XT_MATCH_RECENT=y
CONFIG_NETFILTER_XT_MATCH_HASHLIMIT=y
```

- `RECENT`: 最近のパケットを追跡し、短時間での接続試行を制限します。ポートスキャンや総当たり攻撃の検知・防御に有効です。
- `HASHLIMIT`: ハッシュテーブルを使った接続レート制限により、特定の送信元からの過剰な接続試行を制限します。

### ログ機能とパケット操作

```text
CONFIG_NETFILTER_XT_TARGET_LOG=y
```

- `LOG`: iptables ルールによるログ出力を可能にし、不正侵入試行の記録と分析を行えるようにしています。

---

## おわりに

セキュリティ対策は、侵入されてから対処するだけでは不十分です。

Shizen Boxにおける守備固めは、「入られない」だけでなく、「入口を作らない」「触ったら分かる」設計を意識しています。

不要なサービスの排除、ファイアーウォールによる通信制御、物理デバッグポートの封鎖、そしてカーネルレベルでのDOS対策。これらの基礎対策によって、ペンテスト実施前の段階で、攻撃対象となり得る入口を最小限に抑えることができました。

これらの対策は、JC-STAR★1認証要件への対応も兼ねており、実際のペンテストにおいても有効な防御層として機能しました。

次回（第三回）では、実際に実施された第三者ペネトレーションテストの内容と、侵入試行を検知してSlackへ通知する仕組みについて紹介したいと思います。

同じようにIoT / 組み込みデバイスのセキュリティ対策に向き合っている方の参考になれば幸いです。

### 注意事項

- 本記事は、公開可能な一般的技術知見をもとに、個人の経験として執筆しています。
- 特定の製品仕様、社内限定情報、非公開設定値、実環境を特定可能な情報は含んでいません。
- 設定値・構成・数値は一部簡略化または一般化しています。

記載内容はあくまで一例であり、すべてのIoT機器・システムにそのまま適用できるものではありません。実際の運用にあたっては、対象環境やリスクレベルに応じた検討が必要です。

